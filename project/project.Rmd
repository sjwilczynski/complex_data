---
title: "Complex data - project"
author: "Stanisław Wilczyński, Anna Zaleska"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(results = 'asis');
options(xtable.comment=FALSE)
library(PBImisc)
library(xtable)
library(lattice)
library(lme4)
library(nlme)
#library(lmerTest)

data(kidney)
```


```{r}

xy_kidney <- reshape(kidney[1:10,], direction = "long", varying = list(9:16), v.names = c("MDRD"), times = c(1/4,1,3,6,12,24,36,60))
xy_kidney$ltime <- log(xy_kidney$time)

xyplot(MDRD ~ time | id, xy_kidney, type=c("g","p","r"), xlab = "time since transplant", ylab = "MDRD", pch=19)
xyplot(MDRD ~ ltime | id, xy_kidney, type=c("g","p","r"), xlab = "log(time since transplant)", ylab = "MDRD", pch=19)

lkidney <- reshape(kidney, direction = "long", varying = list(9:16), v.names = c("MDRD"), times = c(1/4,1,3,6,12,24,36,60))
lkidney$ltime <- log(lkidney$time)

```


### Analiza bez efektów losowych (Stachu)


```{r}
for(i in 1:8){
  model.variable <- lm(MDRD ~ lkidney[,i], data = lkidney)
  print(paste("Model for", colnames(lkidney)[i]))
  print(summary(model.variable))
  print("---------------------------------------------------------------------------")
  #donor.age, CIT, discrepanacy.DR
}
```



## time as factor
```{r}
un.model.reml <- gls(MDRD~donor.age+bpl.drugs+recipient.age+discrepancy.AB+discrepancy.DR+CIT+factor(time)*(diabetes+therapy),
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney)

cs.model.reml <- gls(MDRD~donor.age+bpl.drugs+recipient.age+discrepancy.AB+discrepancy.DR+CIT+factor(time)*(diabetes+therapy),
correlation=corCompSymm(form= ~1 | id),
weights=varIdent(form= ~1),
data=lkidney)

ar.model.reml <- gls(MDRD~donor.age+bpl.drugs+recipient.age+discrepancy.AB+discrepancy.DR+CIT+factor(time)*(diabetes+therapy),
correlation=corAR1(form= ~1 | id),
weights=varIdent(form= ~1),
data=lkidney)

car.model.reml <- gls(MDRD~donor.age+bpl.drugs+recipient.age+discrepancy.AB+discrepancy.DR+CIT+factor(time)*(diabetes+therapy),
correlation=corCAR1(form= ~ltime | id),
data=lkidney)

```


```{r}
covar <- getVarCov(un.model)
anova(un.model.reml,ar.model.reml, cs.model.reml, car.model.reml)
print(covar)
```
```{r}
un.model <- gls(MDRD~donor.age+bpl.drugs+recipient.age+discrepancy.AB+discrepancy.DR+CIT+factor(time)*(diabetes+therapy),
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")

un.model.no.int <- gls(MDRD~factor(time)+(donor.age+bpl.drugs+recipient.age+discrepancy.AB+diabetes+discrepancy.DR+CIT+therapy),
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")

quad.model <- gls(MDRD~(ltime + I(ltime^2))*(therapy+diabetes) + (donor.age+bpl.drugs+recipient.age+discrepancy.AB+discrepancy.DR+CIT),
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")

lin.model <- gls(MDRD~(ltime)*(therapy+diabetes) + (donor.age+bpl.drugs+recipient.age+discrepancy.AB+discrepancy.DR+CIT),
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")

cube.model <- gls(MDRD~(ltime + I(ltime^2)+I(time^3))*(therapy+diabetes) + (donor.age+bpl.drugs+recipient.age+discrepancy.AB+discrepancy.DR+CIT),
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")
```


```{r}
anova(quad.model, un.model)
anova(quad.model, lin.model)
anova(un.model.no.int, un.model)
anova(un.model, cube.model)
anova(un.model)
```

```{r}
simpler.un.model <- gls(MDRD~factor(time)*(therapy+diabetes) + (donor.age+bpl.drugs),
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")

simplest.un.model <- gls(MDRD~factor(time)+(therapy) + (donor.age+bpl.drugs),
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")

```

```{r}
anova(simpler.un.model, un.model)
anova(simpler.un.model, simplest.un.model)
anova(simplest.un.model, un.model)
```

```{r}
simplest.un.model.lin <- gls(MDRD~ltime+therapy++donor.age+bpl.drugs,
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")

simplest.un.model.quad <- gls(MDRD~(ltime+I(ltime^2))+therapy+donor.age+bpl.drugs,
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")

simplest.un.model.cube <- gls(MDRD~(ltime+I(ltime^2)+I(ltime^3))+therapy+donor.age+bpl.drugs,
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney, method = "ML")
```

```{r}
anova(simplest.un.model, simplest.un.model.lin, simplest.un.model.quad, simplest.un.model.cube)
```
```{r}
growth.model <- lme(MDRD~(ltime + I(ltime^2))*therapy  + donor.age +  bpl.drugs , random =~ltime + I(ltime^2)|factor(id), data = lkidney, method = "ML")
anova(growth.model, simplest.un.model)
var1 <- var(lkidney$MDRD)
var2 <- var(residuals(simplest.un.model))
(1-var2/var1)*100
```
### Prediction

```{r}
# split to training and test

## 80% of the sample size
smp_size <- floor(0.8 * nrow(kidney))
train_ind <- sample(seq_len(nrow(kidney)), size = smp_size)
scaled_kidney <- kidney

for(i in (1:ncol(kidney))){
  if(is.numeric(kidney[2,i])){
    scaled_kidney[,i] <- scale(kidney[,i])
  } 
}

```

```{r}

kidney_train <- kidney[train_ind, ]
kidney_test <- kidney[-train_ind, ]

lkidney_train <- reshape(kidney_train, direction = "long", varying = list(9:16), v.names = c("MDRD"), times = c(1/4,1,3,6,12,24,36,60))
lkidney_train$ltime <- log(lkidney_train$time)

lkidney_test <- reshape(kidney_test, direction = "long", varying = list(9:16), v.names = c("MDRD"), times = c(1/4,1,3,6,12,24,36,60))
lkidney_test$ltime <- log(lkidney_test$time)

growth.model.predict <- lme(MDRD~(ltime + I(ltime^2))*therapy  + donor.age +  bpl.drugs , random =~ltime + I(ltime^2)|factor(id), data = lkidney_train)

simplest.un.model.predict <- gls(MDRD~factor(time)+therapy+donor.age+bpl.drugs,
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney_train)
```


```{r}

var.test <- var(lkidney_test$MDRD)
var.train <- var(lkidney_train$MDRD)
var.gls.residuals <- var(residuals(simplest.un.model.predict))
var.lme.residuals <- var(residuals(growth.model.predict))

real.values.test <- lkidney_test$MDRD
real.values.train <- lkidney_train$MDRD

predictions.gls.test <- predict(simplest.un.model.predict, lkidney_test)
predictions.lme.test <- predict(growth.model.predict, lkidney_test)
predictions.gls.train <- predict(simplest.un.model.predict, lkidney_train)
predictions.lme.train <- predict(growth.model.predict, lkidney_train)

print("TEST")
print(var.test)
print(mean((real.values.test-predictions.gls.test)**2))
print(mean((real.values.test-predictions.lme.test)**2))

print("TRAIN")
print(var.train)
print(var.gls.residuals)
print(mean((real.values.train-predictions.gls.train)**2))
print(var.lme.residuals)
print(mean((real.values.train-predictions.lme.train)**2))
```


```{r}
kidney_train <- scaled_kidney[train_ind, ]
kidney_test <- scaled_kidney[-train_ind, ]


lkidney_train <- reshape(kidney_train, direction = "long", varying = list(9:16), v.names = c("MDRD"), timevar = "time")
lkidney_train$ltime <- log(lkidney_train$time)

lkidney_test <- reshape(kidney_test, direction = "long", varying = list(9:16), v.names = c("MDRD"), timevar = "time")
lkidney_test$ltime <- lkidney_test$time

growth.model.predict <- lme(MDRD~(ltime + I(ltime^2))*therapy  + donor.age +  bpl.drugs , random =~ltime + I(ltime^2)|factor(id), data = lkidney_train)

simplest.un.model.predict <- gls(MDRD~factor(time)+therapy+donor.age+bpl.drugs,
correlation=corSymm(form= ~1 | id),
weights=varIdent(form= ~1 | time),
data=lkidney_train)
```


```{r}

var.test <- var(lkidney_test$MDRD)
var.train <- var(lkidney_train$MDRD)
var.gls.residuals <- var(residuals(simplest.un.model.predict))
var.lme.residuals <- var(residuals(growth.model.predict))

real.values.test <- lkidney_test$MDRD
real.values.train <- lkidney_train$MDRD

predictions.gls.test <- predict(simplest.un.model.predict, lkidney_test)
predictions.lme.test <- predict(growth.model.predict, lkidney_test)
predictions.gls.train <- predict(simplest.un.model.predict, lkidney_train)
predictions.lme.train <- predict(growth.model.predict, lkidney_train)

print("TEST")
print(var.test)
print(mean((real.values.test-predictions.gls.test)**2))
print(mean((real.values.test-predictions.lme.test)**2))

print("TRAIN")
print(var.train)
print(var.gls.residuals)
print(mean((real.values.train-predictions.gls.train)**2))
print(var.lme.residuals)
print(mean((real.values.train-predictions.lme.train)**2))
```



```{r}
summary(simplest.un.model.predict)
summary(growth.model.predict)
```




### Ania



#### random intercept
```{r}
const.mixed.model2 <- lme(MDRD~ltime, random =~1|factor(id),
                         data = lkidney, method = "ML")
summary(const.mixed.model2)
```


####random intercept and slope
```{r}
lin.mixed.model2 <- lme(MDRD~ltime, random =~ltime|factor(id),
                         data = lkidney, method = "ML")
summary(lin.mixed.model2)
```


#### random intercept and slope quadratic model

```{r}

quadr.mixed.model2 <- lme(MDRD~ltime + I(ltime^2), random =~ltime + I(ltime^2)|factor(id),
                         data = lkidney, method = "ML")
summary(quadr.mixed.model2) 

```


```{r}
anova(const.mixed.model2,lin.mixed.model2,quadr.mixed.model2)
```


#### full model
```{r}
full.model2 <- lme(MDRD~donor.age + recipient.age + therapy + diabetes + bpl.drugs + discrepancy.AB + discrepancy.DR + ltime + I(ltime^2)  , random =~ltime + I(ltime^2)|factor(id), data = lkidney,  method = "ML")
summary(full.model2)
```


```{r}
final.model <- lme(MDRD~donor.age + bpl.drugs + ltime + I(ltime^2)  , random =~ltime + I(ltime^2)|factor(id), data = lkidney,  method = "ML")
final.model2 <- lme(MDRD~donor.age + therapy +  bpl.drugs + ltime + I(ltime^2)  , random =~ltime + I(ltime^2)|factor(id), data = lkidney,  method = "ML")
final.model3 <- lme(MDRD~donor.age + therapy +  bpl.drugs + recipient.age + ltime + I(ltime^2)  , random =~ltime + I(ltime^2)|factor(id), data = lkidney,  method = "ML")
anova(final.model, final.model2)
anova(final.model2, final.model3)
```


```{r}
library(car)
qqPlot(ranef(final.model2)[,1], envelope = FALSE, ylab = expression(a[i]))
qqPlot(ranef(final.model2)[,1], envelope = FALSE, ylab = expression(b[i]))
qqPlot(ranef(final.model2)[,1], envelope = FALSE, ylab = expression(c[i]))
```

#### two stage model - therapy interaction

```{r}
lkidney$ltime2 <- lkidney$ltime^2
coef.kidney <- matrix(NA,ncol = 7, nrow = 0)
for (i in unique(lkidney$id)) {
  model <- lm(MDRD~ltime+ltime2, data = lkidney, subset = id == i)
  model.age <- unique(lkidney[lkidney$id == i, "donor.age"])
  model.drug <- unique(lkidney[lkidney$id == i, "bpl.drugs"])
  model.ther <- unique(lkidney[lkidney$id == i, "therapy"])
  coef.kidney <- rbind(coef.kidney, c(i, model.age, model.drug, model.ther, coef(model)))
  #print(coef(model))
}
colnames(coef.kidney) <- c("id","donor.age","bpl.drugs","therapy","intercept","slope", "quadr.slope")
coef.kidney <- as.data.frame(coef.kidney)
#coef.kidney
```




```{r}
### step two
kidney.int <- lm(intercept~factor(therapy)+donor.age+bpl.drugs, data = coef.kidney)
kidney.slp <- lm(slope~factor(therapy), data = coef.kidney)
kidney.quadr.slp <- lm(quadr.slope~factor(therapy), data = coef.kidney)

info.int <- round(summary(kidney.int)$coefficients[,c(1,4)], 4)
info.int
info.slp <- round(summary(kidney.slp)$coefficients[,c(1,4)], 4)
info.quadr <-round(summary(kidney.quadr.slp)$coefficients[,c(1,4)], 4)

summary(kidney.int)$coefficients
```

```{r}

growth.model <- lme(MDRD~(ltime + I(ltime^2))*therapy  + donor.age +  bpl.drugs , random =~ltime + I(ltime^2)|factor(id), data = lkidney)
info.mixed <- round(summary(growth.model)$tTable[,c(1,5)], 4)
summary(growth.model)$tTable
```


\begin{center}
  \begin{tabular}{c c c}
     & Two-Stage & Mixed Effects \\ \hline
    Intercept & $`r info.int[1,1]` (`r info.int[1,2]`)$ & $`r info.mixed[1,1]` (`r info.mixed[1,2]`)$ \\
    logTime & $`r info.slp[1,1]` (`r info.slp[1,2]`)$ & $`r info.mixed[2,1]` (`r info.mixed[2,2]`)$\\
    $logTime^2$ & $`r info.quadr[1,1]` (`r info.quadr[1,2]`)$ & $`r info.mixed[3,1]` (`r info.mixed[3,2]`)$ \\
   donor.age & $`r info.int[2,1]` (`r info.int[2,2]`)$ & $`r info.mixed[4,1]` (`r info.mixed[4,2]`)$ \\
    therapy.cm & $`r info.int[3,1]` (`r info.int[3,2]`)$ & $`r info.mixed[5,1]` (`r info.mixed[5,2]`)$ \\
   therapy.tc & $`r info.int[4,1]` (`r info.int[4,2]`)$ & $`r info.mixed[6,1]` (`r info.mixed[6,2]`)$ \\
      bpl.drugs & $`r info.int[5,1]` (`r info.int[5,2]`)$ & $`r info.mixed[7,1]` (`r info.mixed[7,2]`)$ \\
     logTime*therapy.cm & $`r info.slp[2,1]` (`r info.slp[2,2]`)$ & $`r info.mixed[8,1]` (`r info.mixed[8,2]`)$ \\
    logTime*therapy.tc & $`r info.slp[3,1]` (`r info.slp[3,2]`)$ & $`r info.mixed[9,1]` (`r info.mixed[9,2]`)$ \\
     $logTime^2$*therapy.cm & $`r info.quadr[2,1]` (`r info.quadr[2,2]`)$ & $`r info.mixed[10,1]` (`r info.mixed[10,2]`)$ \\
    $logTime^2$*therapy.tc & $`r info.quadr[3,1]` (`r info.quadr[3,2]`)$ & $`r info.mixed[11,1]` (`r info.mixed[11,2]`)$ \\

    \hline
  \end{tabular}
\end{center}


```{r}
growth.model <- lme(MDRD~(ltime + I(ltime^2))*therapy  + donor.age +  bpl.drugs , random =~ltime + I(ltime^2)|factor(id), data = lkidney)

var.MDRD <- var(lkidney$MDRD)
var.growth.model <- var(residuals(growth.model))
(1-var.growth.model/var.MDRD)*100
```

#### ltime vs therapy interaction
```{r}
final.model2.ml.inter <- lme(MDRD~donor.age + therapy +  bpl.drugs + ltime + I(ltime^2) + ltime*therapy  , random =~ltime + I(ltime^2)|factor(id), data = lkidney, method = "ML")
anova(final.model2.ml.inter, final.model2)
```
```{r}
growth.model.ml <- lme(MDRD~(ltime + I(ltime^2))*therapy  + donor.age +  bpl.drugs , random =~ltime + I(ltime^2)|factor(id), data = lkidney, method = "ML")
anova(final.model2.ml.inter,growth.model.ml)
```


### cubic time
```{r}
final.model3.ml <- lme(MDRD~donor.age + therapy +  bpl.drugs + ltime + I(ltime^2) +I(ltime^3)  , random =~ltime + I(ltime^2) + I(ltime^3)|factor(id), data = lkidney, method = "ML")
anova(final.model2, final.model3.ml )
```



